---

- name: install docker dependencies
  apt: name=docker.io state=present

- name: start docker
  service: name=docker enabled=yes state=started

- name: download k0s
  get_url:
    url: https://github.com/k0sproject/k0s/releases/download/v0.12.0/k0s-v0.12.0-amd64
    dest: /usr/bin/k0s
    mode: '0755'

- name: install k0s service file
  copy: src={{ item }} dest=/etc/systemd/system/{{ item }} owner=root group=root mode=0644
  with_items:
    - k0s.service
    - k0s-worker.service
  notify:
    - daemon reload


- name: start and enable the k0s service
  service: name=k0s enabled=yes state=started

- name: Wait for controller to come online
  pause:
    seconds: 5

- name: create k0s worker token
  shell:
    cmd: "k0s token create --role worker > /etc/k0s.worker.token"
    creates: /etc/k0s.worker.token


- name: start and enable the k0s worker service
  service: name=k0s-worker enabled=yes state=started
